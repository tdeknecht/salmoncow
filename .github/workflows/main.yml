name: CI

on:
  push:
  # pull_request:
  #   branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    container: 
      image: tdeknecht/aws:latest
      env:
        AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
        AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}

    steps:
      - uses: actions/checkout@v1

      - name: Terraform dir
        run: |
          cd terraform
          
      - name: Set AWS credentials
        run: |
          aws --version
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY

      - name: Terraform INIT and PLAN
        run: |
          terraform init
          terraform plan

      - name: Terraform APPLY
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
        run: |
          terraform apply -auto-approve

